name: ğŸš€ qa-runner-main

on:
  workflow_dispatch:

  workflow_run:
    workflows: ["ğŸš€ QA Branch"]
    types:
      - completed

jobs:
  build:
    runs-on: ubuntu-latest
    # runs-on: [qa-frontend-main]

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with: 
          ref: qa-branch

      - name: ğŸ“¦ Install dependencies
        run: npm install --force

      - name: ğŸ—ï¸ Build
        env:
          NODE_OPTIONS: "--max-old-space-size=6144"  # Setting memory limit here
        run: |
          touch .env
          echo "${{secrets.QA_ENV_FILE}}" > .env
          cat .env

      - name: ğŸ—ï¸ Build with increased memory
        env:
          NODE_OPTIONS: "--max-old-space-size=6144"  # Setting memory limit here
        run: |
          npm run build

      - name: ğŸš€ Upload build
        uses: actions/upload-artifact@v4
        with:
          name: static-site
          path: build/

  release-project:
    name: ğŸš€ Release project
    runs-on: [qa-frontend-main]
    needs: build
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: static-site
    
      - name: ğŸ§ª Test artifact download
        run: |
          ls -R

  email-notification:
    runs-on: ubuntu-latest
    needs: release-project
    steps:
      - name: ğŸ”„ Checkout full history
        uses: actions/checkout@v4
        with:
          ref: qa-branch  # Replace 'gitlog' with your branch name if needed
          fetch-depth: 0  # Fetch the full Git history to access older commits

      - name: ğŸ“ Create file with last 5 commits
        id: create_commit_file
        run: |
          git log -n 7 --pretty=format:" %h | %an | %ad%nMessage: %s%n" --date=format:'%Y-%m-%d %H:%M' >> last_commits.txt
          cat last_commits.txt

      - name: ğŸ“„ Read file content and set environment variable
        id: read_file
        run: |
         content=$(cat last_commits.txt)
         echo "file_content<<EOF" >> $GITHUB_ENV
         echo "$content" >> $GITHUB_ENV
         echo "EOF" >> $GITHUB_ENV

      - name: ğŸ•’ Set deployment timestamp
        id: timestamp
        run: |
          ist_time=$(date -u +"%d-%m-%Y %H:%M" -d "+5 hours 30 minutes")
          echo "ist_timestamp=$ist_time" >> $GITHUB_ENV

      - name: âœ‰ï¸ Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
         server_address: smtp.gmail.com
         server_port: 587
         username: ${{ secrets.GMAIL_USERNAME }}
         password: ${{ secrets.GMAIL_APP_PASSWORD }}
         subject: "ğŸš€Deployment successfully completed for Dev Environment ${{ env.ist_timestamp }}"
         to: "yash.shirke@argantechnology.com, akash.bhosale@argantechnology.com, aniket.potbhare@argantechnology.com, pradnya.bhaik@argantechnology.com"
         from: bhaikpradnya95@gmail.com
         body: |
            Dear Team,
            ğŸš€The deployment to the Dev Environment was successfully completed on ${{ env.ist_timestamp }}ğŸš€.
            
            ${{ env.file_content }}
            
            
            If you have any questions or require further assistance, please let us know.
            Best regards,
            Argan Technology Services Pvt Ltd

      - name: ğŸ§¹ Clean up last_commits.txt
        run: rm last_commits.txt
# Advantages:
# - âš™ï¸ Automation: Automates the build and deployment process whenever changes are pushed to the main branch.
# - ğŸ“¦ Artifact Management: Uses GitHub Actions to manage and transfer artifacts (the build output) between jobs.

# Disadvantages:
# - ğŸ  Self-Hosted Runner Dependency: The "release-project" job relies on a self-hosted runner, which may require additional setup and maintenance.
# - ğŸ“ Limited Explanation: It's recommended to provide more detailed comments or explanations within the workflow file for better documentation and understanding.
